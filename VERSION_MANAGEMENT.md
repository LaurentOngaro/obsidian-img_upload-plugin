# Version Management System - Implementation Summary

## Overview

A complete build version management system has been implemented for the obsidian-img_upload-plugin. The system automatically tracks and displays plugin versions in the Settings UI.

## What Was Implemented

### 1. PowerShell Build Script (`build.ps1`)

A new build script that:

- Reads the plugin version from `manifest.json` (e.g., `1.0.2`)
- Manages an auto-incrementing build number stored in a `VERSION` file
- Generates `build-info.json` with metadata including:
  - Plugin version
  - Incrementing build number
  - Build timestamp
- Executes esbuild to bundle the plugin

**Usage:**

```bash
npm run build:win
# or
powershell -ExecutionPolicy Bypass -File ".\build.ps1"
```

### 2. Version File Management

- **`VERSION`** - Plain text file tracking the build counter (starts at 0, increments with each build)
- **`build-info.json`** - Generated file containing:
  ```json
  {
    "version": "1.0.2",
    "buildNumber": 5,
    "buildTime": "2025-12-27T18:43:25Z"
  }
  ```

### 3. Plugin Code Updates (`src/main.ts`)

Added to the `CloudinaryPlugin` class:

- `buildInfo` property - stores loaded build metadata
- `loadBuildInfo()` method - loads build-info.json at plugin startup
- `getBuildString()` method - formats the version display as `build vX.X.X #NUMBER`

The plugin now:

1. Loads build info on startup (with fallback to defaults)
2. Displays the build version in the Settings UI footer
3. Gracefully handles missing build-info.json in development

### 4. Settings UI Enhancement

Added version display at the bottom of the Settings tab:

```
build v1.0.2 #5
```

Styled with:

- Centered alignment
- Muted color (matches VS Code's text-muted)
- Small font size (0.85em)
- Top margin for separation

### 5. Git Configuration

Updated `.gitignore` to exclude:

- `VERSION` - Build counter (changes every build)
- `build-info.json` - Generated file (changes every build)

These files should NOT be committed to version control.

## File Changes Summary

| File                     | Change         | Purpose                                         |
| ------------------------ | -------------- | ----------------------------------------------- |
| `build.ps1`              | Created        | PowerShell build script with version management |
| `VERSION`                | Created        | Tracks auto-incrementing build number           |
| `build-info.json`        | Auto-generated | Metadata file generated by build script         |
| `src/main.ts`            | Modified       | Added build info loading and display            |
| `package.json`           | Modified       | Updated `build:win` script to use build.ps1     |
| `.gitignore`             | Modified       | Added VERSION and build-info.json               |
| `BUILD.md`               | Created        | Documentation of the build system               |
| `test-build-version.ps1` | Created        | Demo script to test version management          |

## Usage

### Standard Build (Linux/Mac)

```bash
npm run build
```

Runs esbuild without version management.

### Windows Build with Version Management

```bash
npm run build:win
```

Runs build.ps1 which:

1. Increments the build number
2. Generates build-info.json
3. Runs esbuild
4. Displays build status

### Display in Plugin Settings

The plugin displays in the Settings tab:

- **Before:** Just the manifest version
- **After:** `build v1.0.2 #5` (version from manifest + build counter)

## Build Number Management

### Auto-Increment Behavior

- Starts at 0 (initial `VERSION` file content)
- Increments by 1 with each `build.ps1` execution
- Reset by deleting the `VERSION` file
- Not affected by standard `npm run build`

### Example Build Sequence

```
Build 1: build v1.0.2 #1
Build 2: build v1.0.2 #2
Build 3: build v1.0.2 #3
Build 4: build v1.0.2 #4
Build 5: build v1.0.2 #5
```

If manifest.json version is updated to 1.0.3:

```
Build 6: build v1.0.3 #6
Build 7: build v1.0.3 #7
```

## Error Handling

The plugin gracefully handles:

- Missing `build-info.json` (uses defaults: version 1.0.0, buildNumber 0)
- Network errors when fetching build-info.json
- Multiple possible paths for the build-info.json file

## Testing

All existing tests pass with the new changes:

- 16 tests passing
- No TypeScript compilation errors
- CI checks (test + build) passing

Run tests with:

```bash
npm run test:e2e -- --run
npm run ci:checks
```

## Future Enhancements

Possible improvements:

- Include git commit hash in build-info.json
- Add detailed changelog reference
- Generate build history log
- Integrate with GitHub releases API
- Add build timestamp to dev tools
